class Air{constructor(room,options={}){this.serverUrl=options.serverUrl||"wss://air.arraystory.com",this.room=room,this.id=options.id||this._generateId(),this.name=options.name||"Anonymous",this.ws=null,this.listeners={},this.reconnectInterval=null,this.reconnectAttempts=0,this.maxReconnectAttempts=10,this.reconnectDelay=3e3,this.users=[],this.typingUsers=new Set,this.typingTimeout=null}_generateId(){return"user_"+Math.random().toString(36).substr(2,9)+Date.now().toString(36)}connect(){const wsUrl=`${this.serverUrl}/ws?channel=${encodeURIComponent(this.room)}&id=${encodeURIComponent(this.id)}&name=${encodeURIComponent(this.name)}`;this.ws=new WebSocket(wsUrl),this.ws.onopen=()=>{this.reconnectAttempts=0,this.reconnectInterval&&(clearInterval(this.reconnectInterval),this.reconnectInterval=null),this._emit("connect",{room:this.room,id:this.id,name:this.name})},this.ws.onmessage=event=>{try{const data=JSON.parse(event.data);console.log("[Air] WS Message received:",data);console.log("[Air] Message type:",data.type);console.log("[Air] Message keys:",Object.keys(data));const msgType=data.type;if(msgType==="text"||msgType==="image"||msgType==="file"){this._emit("message",data)}else if(msgType==="message"){this._emit("message",data)}else if(msgType==="direct"){this._emit("direct",data)}else if(msgType==="typing"){const typingSender=data.sender||data.name;const typingFrom=data.from||data.id;console.log("[Air] Typing from:",typingSender,"(ID:",typingFrom,")");if(typingFrom!==this.id){console.log("[Air] Adding to typing users:",typingSender);this.typingUsers.add(typingSender);const typingArray=Array.from(this.typingUsers);console.log("[Air] Emitting typing event with:",typingArray);this._emit("typing",typingArray);clearTimeout(this.typingTimeouts&&this.typingTimeouts[typingSender]);if(!this.typingTimeouts)this.typingTimeouts={};this.typingTimeouts[typingSender]=setTimeout(()=>{console.log("[Air] Auto-clearing typing for",typingSender,"after timeout");this.typingUsers.delete(typingSender);const cleared=Array.from(this.typingUsers);this._emit("typing",cleared);delete this.typingTimeouts[typingSender]},5e3)}else{console.log("[Air] Ignoring own typing indicator")}}else if(msgType==="typingStopped"){const stoppedSender=data.sender||data.name;const stoppedFrom=data.from||data.id;console.log("[Air] Typing stopped from:",stoppedSender,"(ID:",stoppedFrom,")");if(stoppedFrom!==this.id){this.typingUsers.delete(stoppedSender);if(this.typingTimeouts&&this.typingTimeouts[stoppedSender]){clearTimeout(this.typingTimeouts[stoppedSender]);delete this.typingTimeouts[stoppedSender]}const typingArray=Array.from(this.typingUsers);console.log("[Air] Removed from typing, now:",typingArray);this._emit("typing",typingArray)}}else if(msgType==="userList"||msgType==="userlist"){console.log("[Air] Userlist received:",data.users);this.users=data.users||[];console.log("[Air] Emitting userlist event with:",this.users);this._emit("userlist",this.users)}else if(msgType==="join"){const joinUser={id:data.from||data.id,name:data.sender||data.name};console.log("[Air] User joined:",joinUser);this._emit("join",joinUser)}else if(msgType==="leave"){const leaveUser={id:data.from||data.id,name:data.sender||data.name};console.log("[Air] User left:",leaveUser);this._emit("leave",leaveUser)}else{console.log("[Air] Unknown type:",msgType);this._emit("message",data)}}catch(e){console.error("[Air] Parse error:",e);this._emit("message",event.data)}},this.ws.onerror=error=>{this._emit("error",error)},this.ws.onclose=event=>{this._emit("disconnect",{code:event.code,reason:event.reason}),this.reconnectAttempts<this.maxReconnectAttempts&&(this.reconnectAttempts++,this.reconnectInterval=setTimeout(()=>this.connect(),this.reconnectDelay))}}_handleTyping(data){data.from!==this.id&&(this.typingUsers.add(data.sender),this._emit("typing",Array.from(this.typingUsers)),setTimeout(()=>{this.typingUsers.delete(data.sender),this._emit("typing",Array.from(this.typingUsers))},3e3))}onConnect(callback){return this.on("connect",callback),this}onMessage(callback){return this.on("message",callback),this}onDirect(callback){return this.on("direct",callback),this}onUserList(callback){return this.on("userlist",callback),this}onJoin(callback){return this.on("join",callback),this}onLeave(callback){return this.on("leave",callback),this}onTyping(callback){return this.on("typing",callback),this}onDisconnect(callback){return this.on("disconnect",callback),this}onError(callback){return this.on("error",callback),this}onSent(callback){return this.on("sent",callback),this}send(data){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const payload={channel:this.room,type:"message",data:data};this.ws.send(JSON.stringify(payload)),this._emit("sent",data)}}sendTo(userId,data){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const payload={channel:this.room,type:"direct",to:userId,data:data};this.ws.send(JSON.stringify(payload)),this._emit("sent",{to:userId,data:data})}}typing(){console.log("[Air] typing() called");if(this.ws&&this.ws.readyState===WebSocket.OPEN){console.log("[Air] WebSocket is open, sending typing indicator");this.typingTimeout&&clearTimeout(this.typingTimeout);const payload={channel:this.room,type:"typing"};console.log("[Air] Sending typing payload:",payload);this.ws.send(JSON.stringify(payload)),this.typingTimeout=setTimeout(()=>{this.typingTimeout=null},2e3)}else{console.log("[Air] WebSocket not open, cannot send typing")}}getUsers(){return this.users}getUserCount(){return this.users.length}on(event,callback){this.listeners[event]||(this.listeners[event]=[]),this.listeners[event].push(callback)}off(event,callback){this.listeners[event]&&(this.listeners[event]=this.listeners[event].filter(cb=>cb!==callback))}disconnect(){this.reconnectInterval&&(clearInterval(this.reconnectInterval),this.reconnectInterval=null),this.ws&&(this.ws.close(),this.ws=null)}isConnected(){return this.ws&&this.ws.readyState===WebSocket.OPEN}_emit(event,data){console.log(`[Air] Emitting event: ${event}, listeners count:`,this.listeners[event]?this.listeners[event].length:0);this.listeners[event]&&this.listeners[event].forEach(callback=>{try{callback(data)}catch(e){console.error(`Error in ${event} listener:`,e)}})}}if(typeof module!=="undefined"&&module.exports){module.exports=Air}if(typeof window!=="undefined"){window.RealtimeClient=Air}
