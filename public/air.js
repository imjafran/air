class Air{constructor(room,options={}){this.serverUrl=options.serverUrl||"wss://air.arraystory.com",this.room=room,this.id=options.id||this._generateId(),this.name=options.name||"Anonymous",this.ws=null,this.listeners={},this.reconnectInterval=null,this.reconnectAttempts=0,this.maxReconnectAttempts=10,this.reconnectDelay=3e3,this.users=[],this.typingUsers=new Set,this.typingTimeout=null}_generateId(){return"user_"+Math.random().toString(36).substr(2,9)+Date.now().toString(36)}connect(){const wsUrl=`${this.serverUrl}/ws?channel=${encodeURIComponent(this.room)}&id=${encodeURIComponent(this.id)}&name=${encodeURIComponent(this.name)}`;this.ws=new WebSocket(wsUrl),this.ws.onopen=()=>{this.reconnectAttempts=0,this.reconnectInterval&&(clearInterval(this.reconnectInterval),this.reconnectInterval=null),this._emit("connect",{room:this.room,id:this.id,name:this.name})},this.ws.onmessage=event=>{try{const data=JSON.parse(event.data);console.log("[Air] WS Message received:",data);const msgType=data.type;if(msgType==="text"||msgType==="image"||msgType==="file"){this._emit("message",data)}else if(msgType==="message"){this._emit("message",data)}else if(msgType==="direct"){this._emit("direct",data)}else if(msgType==="typing"){this.typingUsers.add(data.sender);this._emit("typing",Array.from(this.typingUsers));setTimeout(()=>{this.typingUsers.delete(data.sender);this._emit("typing",Array.from(this.typingUsers))},3e3)}else if(msgType==="typingStopped"){this.typingUsers.delete(data.sender);this._emit("typing",Array.from(this.typingUsers))}else if(msgType==="userList"||msgType==="userlist"){this.users=data.users||[];this._emit("userlist",this.users)}else if(msgType==="join"){this._emit("join",{id:data.from||data.id,name:data.sender||data.name})}else if(msgType==="leave"){this._emit("leave",{id:data.from||data.id,name:data.sender||data.name})}else{console.log("[Air] Unknown type:",msgType);this._emit("message",data)}}catch(e){console.error("[Air] Parse error:",e);this._emit("message",event.data)}},this.ws.onerror=error=>{this._emit("error",error)},this.ws.onclose=event=>{this._emit("disconnect",{code:event.code,reason:event.reason}),this.reconnectAttempts<this.maxReconnectAttempts&&(this.reconnectAttempts++,this.reconnectInterval=setTimeout(()=>this.connect(),this.reconnectDelay))}}_handleTyping(data){data.from!==this.id&&(this.typingUsers.add(data.sender),this._emit("typing",Array.from(this.typingUsers)),setTimeout(()=>{this.typingUsers.delete(data.sender),this._emit("typing",Array.from(this.typingUsers))},3e3))}onConnect(callback){return this.on("connect",callback),this}onMessage(callback){return this.on("message",callback),this}onDirect(callback){return this.on("direct",callback),this}onUserList(callback){return this.on("userlist",callback),this}onJoin(callback){return this.on("join",callback),this}onLeave(callback){return this.on("leave",callback),this}onTyping(callback){return this.on("typing",callback),this}onDisconnect(callback){return this.on("disconnect",callback),this}onError(callback){return this.on("error",callback),this}onSent(callback){return this.on("sent",callback),this}send(data){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const payload={channel:this.room,type:"message",data:data};this.ws.send(JSON.stringify(payload)),this._emit("sent",data)}}sendTo(userId,data){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const payload={channel:this.room,type:"direct",to:userId,data:data};this.ws.send(JSON.stringify(payload)),this._emit("sent",{to:userId,data:data})}}typing(){if(this.ws&&this.ws.readyState===WebSocket.OPEN){this.typingTimeout&&clearTimeout(this.typingTimeout);const payload={channel:this.room,type:"typing"};this.ws.send(JSON.stringify(payload)),this.typingTimeout=setTimeout(()=>{this.typingTimeout=null},2e3)}}getUsers(){return this.users}getUserCount(){return this.users.length}on(event,callback){this.listeners[event]||(this.listeners[event]=[]),this.listeners[event].push(callback)}off(event,callback){this.listeners[event]&&(this.listeners[event]=this.listeners[event].filter(cb=>cb!==callback))}disconnect(){this.reconnectInterval&&(clearInterval(this.reconnectInterval),this.reconnectInterval=null),this.ws&&(this.ws.close(),this.ws=null)}isConnected(){return this.ws&&this.ws.readyState===WebSocket.OPEN}_emit(event,data){this.listeners[event]&&this.listeners[event].forEach(callback=>{try{callback(data)}catch(e){console.error(`Error in ${event} listener:`,e)}})}}if(typeof module!=="undefined"&&module.exports){module.exports=Air}if(typeof window!=="undefined"){window.RealtimeClient=Air}
